name: Deploy Instagram API to K3s

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, ARM64]

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.31.0

      - name: 🔐 Configure kubectl with token
        run: |
          kubectl config set-cluster vps-oracle-k3s \
            --server=https://132.226.86.74:6443 \
            --insecure-skip-tls-verify=true
          
          kubectl config set-credentials github-deployer \
            --token=${{ secrets.KUBE_TOKEN }}
          
          kubectl config set-context github-deployer@vps-oracle-k3s \
            --cluster=vps-oracle-k3s \
            --user=github-deployer \
            --namespace=instagram-api
          
          kubectl config use-context github-deployer@vps-oracle-k3s

      - name: ✅ Verificar conexão
        run: |
          kubectl config view --minify
          echo "✅ Conectado ao cluster!"
          kubectl get ns instagram-api
          

      - name: 🧱 Namespace
        run: |
          kubectl create namespace instagram-api --dry-run=client -o yaml | kubectl apply -f -

      # ADICIONE ESTES PASSOS AQUI:
      - name: 🚀 Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/secret-instagram.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: 🔄 Rollout restart deployment
        run: |
          kubectl rollout restart deployment/instagram-api -n instagram-api
          kubectl rollout status deployment/instagram-api -n instagram-api --timeout=5m

      - name: 📊 Show deployment status
        run: |
          kubectl get pods -n instagram-api
          kubectl get svc -n instagram-api
          kubectl get ingress -n instagram-api