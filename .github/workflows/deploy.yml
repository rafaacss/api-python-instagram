name: Deploy Instagram API to K3s

on:
  push:
    branches: [ main ]   # ajuste se quiser development etc.
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, ARM64]   # igual ao seu outro projeto

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.31.0

      - name: 🔐 Configurar kubeconfig (K3s local)
        run: |
          mkdir -p $HOME/.kube
          # Se o runner roda como root, pode remover 'sudo'
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $USER:$USER $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          # troca 127.0.0.1 pelo IP público se necessário (evita proxy local)
          # sed -i "s#server: https\?://127\.0\.0\.1:6443#server: https://132.226.86.74:6443#g" $HOME/.kube/config || true

      - name: ✅ Verificar conexão
        run: |
          kubectl config view --minify
          echo "Server URL:" && kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'; echo
          kubectl get nodes

      - name: 🧱 Namespace
        run: |
          kubectl create namespace instagram-api --dry-run=client -o yaml | kubectl apply -f -

      # (Opcional) View cluster-wide para logs/diagnósticos
      # - name: 🔭 Dar view cluster-wide (opcional)
      #   run: |
      #
